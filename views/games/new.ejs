<%- include('../layout', { body: `
<!-- Chalkboard Header -->
<div class="mb-8 flex items-center gap-4">
  <div class="w-12 h-12 rounded-full bg-pub-wood-medium flex items-center justify-center border-2 border-pub-wood-light">
    <span class="text-2xl">üìù</span>
  </div>
  <h1 class="text-2xl font-pub-heading font-bold text-pub-chalk-text">Chalk Up a Score</h1>
</div>

${typeof error !== 'undefined' && error ? '<div class="alert alert-error mb-6">' + error + '</div>' : ''}

<form action="/games" method="POST" id="game-form" class="card p-6 space-y-6">
  <!-- Date Field -->
  <div>
    <label for="playedAt" class="block text-sm font-pub-heading text-pub-chalk-text mb-2 uppercase tracking-wider">Date Played</label>
    <input
      type="date"
      id="playedAt"
      name="playedAt"
      value="${new Date().toISOString().split('T')[0]}"
      required
      class="input w-full sm:w-auto"
    >
  </div>

  <!-- Game Type Field -->
  <div>
    <label for="gameType" class="block text-sm font-pub-heading text-pub-chalk-text mb-2 uppercase tracking-wider">Game Type</label>
    <select id="gameType" name="gameType" class="input w-full sm:w-auto">
      <option value="Cricket" selected>ü¶ó Cricket</option>
      <option value="301">üéØ 301</option>
      <option value="501">üéØ 501</option>
      <option value="Around the World">üåç Around the World</option>
      <option value="Other">üé≤ Other</option>
    </select>
    <p id="game-hint" class="mt-2 text-sm text-pub-chalk-accent italic"></p>
  </div>

  <!-- Players Section -->
  <div>
    <label class="block text-sm font-pub-heading text-pub-chalk-text mb-3 uppercase tracking-wider">Players</label>
    <div id="players-container" class="space-y-3">
      <!-- Player 1 -->
      <div class="player-row flex flex-wrap gap-3 items-center p-4 bg-pub-brown-700/50 rounded-lg border-2 border-pub-wood-medium">
        <select name="players[0][userId]" required class="flex-1 min-w-[150px] px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text focus:outline-none focus:border-neon-blue text-sm">
          <option value="">Select player...</option>
          ${allUsers.map(u => '<option value="' + u.id + '">' + u.name + '</option>').join('')}
        </select>
        <input type="number" name="players[0][score]" placeholder="Score" class="score-input w-24 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text placeholder-pub-chalk-accent focus:outline-none focus:border-neon-blue text-sm font-pub-display" style="font-size:12px;">
        <label class="winner-checkbox inline-flex items-center gap-2 text-sm text-pub-chalk-text cursor-pointer">
          <input type="checkbox" name="players[0][isWinner]" value="true" class="winner-input w-5 h-5 rounded border-pub-wood-medium bg-pub-green-800 text-neon-green focus:ring-neon-green focus:ring-offset-pub-brown-900">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 text-neon-green" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Winner
          </span>
        </label>
        <input type="number" name="players[0][checkoutDarts]" placeholder="Darts" min="1" max="170" class="checkout-input w-20 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-neon-green placeholder-pub-chalk-accent focus:outline-none focus:border-neon-green text-sm font-pub-display" style="display:none; font-size:12px;">
      </div>
      <!-- Player 2 -->
      <div class="player-row flex flex-wrap gap-3 items-center p-4 bg-pub-brown-700/50 rounded-lg border-2 border-pub-wood-medium">
        <select name="players[1][userId]" required class="flex-1 min-w-[150px] px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text focus:outline-none focus:border-neon-blue text-sm">
          <option value="">Select player...</option>
          ${allUsers.map(u => '<option value="' + u.id + '">' + u.name + '</option>').join('')}
        </select>
        <input type="number" name="players[1][score]" placeholder="Score" class="score-input w-24 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text placeholder-pub-chalk-accent focus:outline-none focus:border-neon-blue text-sm font-pub-display" style="font-size:12px;">
        <label class="winner-checkbox inline-flex items-center gap-2 text-sm text-pub-chalk-text cursor-pointer">
          <input type="checkbox" name="players[1][isWinner]" value="true" class="winner-input w-5 h-5 rounded border-pub-wood-medium bg-pub-green-800 text-neon-green focus:ring-neon-green focus:ring-offset-pub-brown-900">
          <span class="flex items-center gap-1">
            <svg class="w-4 h-4 text-neon-green" fill="currentColor" viewBox="0 0 20 20">
              <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/>
            </svg>
            Winner
          </span>
        </label>
        <input type="number" name="players[1][checkoutDarts]" placeholder="Darts" min="1" max="170" class="checkout-input w-20 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-neon-green placeholder-pub-chalk-accent focus:outline-none focus:border-neon-green text-sm font-pub-display" style="display:none; font-size:12px;">
      </div>
    </div>
    <button type="button" id="add-player" class="mt-3 btn btn-secondary btn-sm inline-flex items-center gap-2">
      <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
      </svg>
      Add Player
    </button>
  </div>

  <!-- Notes Field -->
  <div>
    <label for="notes" class="block text-sm font-pub-heading text-pub-chalk-text mb-2 uppercase tracking-wider">Notes (optional)</label>
    <textarea
      id="notes"
      name="notes"
      rows="3"
      placeholder="Any memorable moments from the match..."
      class="input resize-none"
    ></textarea>
  </div>

  <!-- Form Actions -->
  <div class="flex flex-col-reverse sm:flex-row gap-3 sm:justify-end pt-4 border-t-2 border-pub-wood-medium/50">
    <a href="/" class="btn btn-secondary">
      Cancel
    </a>
    <button type="submit" class="btn btn-primary inline-flex items-center gap-2">
      <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
      </svg>
      Chalk It Up
    </button>
  </div>
</form>

<script>
const allUsers = ${JSON.stringify(allUsers)};
let playerCount = 2;

// Games where highest score wins (winner auto-calculated)
const SCORE_BASED_GAMES = ['Cricket'];
// Games where first to zero wins (checkout darts optional)
const COUNTDOWN_GAMES = ['301', '501'];

function isScoreBasedGame(gameType) {
  return SCORE_BASED_GAMES.includes(gameType);
}

function isCountdownGame(gameType) {
  return COUNTDOWN_GAMES.includes(gameType);
}

function updateFormForGameType(gameType) {
  const scoreBased = isScoreBasedGame(gameType);
  const countdown = isCountdownGame(gameType);
  const hintEl = document.getElementById('game-hint');

  // Update hint text with pub-style language
  if (scoreBased) {
    hintEl.textContent = 'üéØ Highest score takes the round. Draws are settled by a tied high score.';
  } else if (countdown) {
    hintEl.textContent = 'üéØ First to checkout wins. Mark the champion and their finishing darts.';
  } else if (gameType === 'Around the World') {
    hintEl.textContent = 'üåç First to hit all numbers claims victory. Select the winner.';
  } else {
    hintEl.textContent = 'üé≤ Pick your poison and mark the winner!';
  }

  // Toggle visibility of score inputs, winner checkboxes, and checkout inputs
  document.querySelectorAll('.score-input').forEach(el => {
    el.style.display = scoreBased ? '' : 'none';
    if (!scoreBased) el.value = '';
  });
  document.querySelectorAll('.winner-checkbox').forEach(el => {
    el.style.display = scoreBased ? 'none' : '';
    if (scoreBased) el.querySelector('input').checked = false;
  });
  document.querySelectorAll('.checkout-input').forEach(el => {
    el.style.display = countdown ? '' : 'none';
    if (!countdown) el.value = '';
  });
}

// Listen for game type changes
document.getElementById('gameType').addEventListener('change', function() {
  updateFormForGameType(this.value);
});

// Initialize on page load
updateFormForGameType(document.getElementById('gameType').value);

document.getElementById('add-player').addEventListener('click', function() {
  const container = document.getElementById('players-container');
  const gameType = document.getElementById('gameType').value;
  const scoreBased = isScoreBasedGame(gameType);
  const countdown = isCountdownGame(gameType);
  const row = document.createElement('div');
  row.className = 'player-row flex flex-wrap gap-3 items-center p-4 bg-pub-brown-700/50 rounded-lg border-2 border-pub-wood-medium animate-chalk-write';
  row.innerHTML = '<select name="players[' + playerCount + '][userId]" class="flex-1 min-w-[150px] px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text focus:outline-none focus:border-neon-blue text-sm"><option value="">Select player...</option>' + allUsers.map(u => '<option value="' + u.id + '">' + u.name + '</option>').join('') + '</select><input type="number" name="players[' + playerCount + '][score]" placeholder="Score" class="score-input w-24 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-pub-chalk-text placeholder-pub-chalk-accent focus:outline-none focus:border-neon-blue text-sm font-pub-display" style="display:' + (scoreBased ? '' : 'none') + '; font-size:12px;"><label class="winner-checkbox inline-flex items-center gap-2 text-sm text-pub-chalk-text cursor-pointer" style="display:' + (scoreBased ? 'none' : '') + '"><input type="checkbox" name="players[' + playerCount + '][isWinner]" value="true" class="winner-input w-5 h-5 rounded border-pub-wood-medium bg-pub-green-800 text-neon-green focus:ring-neon-green focus:ring-offset-pub-brown-900"><span class="flex items-center gap-1"><svg class="w-4 h-4 text-neon-green" fill="currentColor" viewBox="0 0 20 20"><path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z"/></svg>Winner</span></label><input type="number" name="players[' + playerCount + '][checkoutDarts]" placeholder="Darts" min="1" max="170" class="checkout-input w-20 px-3 py-2 bg-pub-green-800/50 border-2 border-pub-wood-medium rounded text-neon-green placeholder-pub-chalk-accent focus:outline-none focus:border-neon-green text-sm font-pub-display" style="display:' + (countdown ? '' : 'none') + '; font-size:12px;"><button type="button" onclick="this.parentElement.remove()" class="p-2 text-pub-chalk-accent hover:text-neon-orange hover:bg-neon-orange/10 rounded-lg transition-colors duration-200"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg></button>';
  container.appendChild(row);
  playerCount++;
});
</script>
` }) %>
